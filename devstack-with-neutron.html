<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>How to set DevStack with Neutron - Bits and Pieces</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://pshchelo.github.io/devstack-with-neutron.html">

        <meta name="author" content="Pavlo Shchelokovskyy" />
        <meta name="keywords" content="devstack,openstack" />
        <meta name="description" content="tips and tricks on setting DevStack" />

        <meta property="og:site_name" content="Bits and Pieces" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="How to set DevStack with Neutron"/>
        <meta property="og:url" content="https://pshchelo.github.io/devstack-with-neutron.html"/>
        <meta property="og:description" content="tips and tricks on setting DevStack"/>
        <meta property="article:published_time" content="2014-04-21" />
            <meta property="article:section" content="work" />
            <meta property="article:tag" content="devstack" />
            <meta property="article:tag" content="openstack" />
            <meta property="article:author" content="Pavlo Shchelokovskyy" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://pshchelo.github.io/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://pshchelo.github.io/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://pshchelo.github.io/theme/css/pygments/native.css" rel="stylesheet">
        <link href="https://pshchelo.github.io/theme/css/typogrify.css" rel="stylesheet">
    <link rel="stylesheet" href="https://pshchelo.github.io/theme/css/style.css" type="text/css"/>

        <link href="https://pshchelo.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Bits and Pieces ATOM Feed"/>



        <link href="https://pshchelo.github.io/feeds/work.atom.xml" type="application/atom+xml" rel="alternate"
              title="Bits and Pieces work ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://pshchelo.github.io/" class="navbar-brand">
Bits and Pieces            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="https://pshchelo.github.io/pages/about-me.html">
                             About&nbsp;Me
                          </a></li>
                        <li >
                            <a href="https://pshchelo.github.io/category/play.html">Play</a>
                        </li>
                        <li class="active">
                            <a href="https://pshchelo.github.io/category/work.html">Work</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="https://pshchelo.github.io/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://pshchelo.github.io/devstack-with-neutron.html"
                       rel="bookmark"
                       title="Permalink to How to set DevStack with Neutron">
                        How to set DevStack with&nbsp;Neutron
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2014-04-21T00:00:00+03:00"> Mon 21 April 2014</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://pshchelo.github.io/tag/devstack.html">devstack</a>
        /
	<a href="https://pshchelo.github.io/tag/openstack.html">openstack</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>These tips try to solve problems I stumbled upon when starting my work
on OpenStack, Grizzly release at that time. I&#8217;ve tried to accommodate
the solutions for recent DevStack (early Juno as of this
writing), but some things might still be incorrect or already fixed -
<span class="caps">YMMV</span>.</p>
<p>All notes are concerning Ubuntu/Debian on an Intel <span class="caps">CPU</span>, so for other systems
some changes might be&nbsp;necessary.</p>
<dl class="docutils">
<dt>Update</dt>
<dd>Tried DevStack on fresh Ubuntu 14.04 <span class="caps">LTS</span> (Trusty Thar), updated&nbsp;tips.</dd>
</dl>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#install-devstack" id="id1">Install&nbsp;DevStack</a></li>
<li><a class="reference internal" href="#allow-vm-internet-connectivity" id="id2">Allow <span class="caps">VM</span> Internet&nbsp;connectivity</a></li>
<li><a class="reference internal" href="#note-on-unstack-sh-and-rebooting" id="id3">Note on <tt class="docutils literal">unstack.sh</tt> and&nbsp;rebooting</a></li>
<li><a class="reference internal" href="#restore-settings-after-reboot" id="id4">Restore settings after reboot</a><ul>
<li><a class="reference internal" href="#stack-volumes" id="id5">Stack&nbsp;volumes</a></li>
<li><a class="reference internal" href="#nat-settings" id="id6"><span class="caps">NAT</span>&nbsp;settings</a></li>
<li><a class="reference internal" href="#bridges" id="id7">Bridges</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sharing-files-between-your-physical-machine-and-devstack-host" id="id8">Sharing files between your physical machine and DevStack&nbsp;host</a></li>
<li><a class="reference internal" href="#problems-with-receiving-ips-for-vms" id="id9">Problems with receiving IPs for&nbsp;VMs</a></li>
<li><a class="reference internal" href="#nested-kvm" id="id10">Nested <span class="caps">KVM</span></a></li>
</ul>
</div>
<div class="section" id="install-devstack">
<h2><a class="toc-backref" href="#id1">Install&nbsp;DevStack</a></h2>
<ul>
<li><p class="first">Prepare a <span class="caps">VM</span> for DevStack&nbsp;deployment</p>
</li>
<li><p class="first">in this <span class="caps">VM</span> install <tt class="docutils literal">git</tt></p>
<pre class="literal-block">
sudo apt-get install git
</pre>
</li>
<li><p class="first">clone DevStack&nbsp;repo</p>
<pre class="literal-block">
git clone https://github.com/openstack-dev/devstack.git
</pre>
</li>
<li><p class="first">create <tt class="docutils literal">local.conf</tt> file in the <tt class="docutils literal">devstack</tt> folder to enable
Neutron and set some passwords (choose your own if you&nbsp;wish)</p>
<pre class="literal-block">
[[local|localrc]]
DATABASE_PASSWORD=password
RABBIT_PASSWORD=password
SERVICE_TOKEN=password
SERVICE_PASSWORD=password
ADMIN_PASSWORD=password
disable_service n-net
enable_service q-svc q-agt q-dhcp q-l3 q-meta neutron
</pre>
<ul class="simple">
<li>I have a <a class="reference external" href="https://github.com/pshchelo/stackdev">repo</a> with my
DevStack customizations, you might want to check it&nbsp;out.</li>
</ul>
</li>
<li><p class="first">install&nbsp;DevStack</p>
<pre class="literal-block">
./stack.sh
</pre>
</li>
</ul>
<p>Now you should have a working DevStack installation. You can login into
Horizon, or join the running stack with <tt class="docutils literal">./rejoin_stack.sh</tt> command
and check console outputs of all the running services for debug and error info.
There are some networks and routers created by default, so you can
start VMs and attach floating IPs to&nbsp;them.</p>
</div>
<div class="section" id="allow-vm-internet-connectivity">
<h2><a class="toc-backref" href="#id2">Allow <span class="caps">VM</span> Internet&nbsp;connectivity</a></h2>
<p>You might stumble on networking issues concerning outside access,
like pinging or accessing Internet resources outside of your DevStack.
First you need to change the Security Group settings -
the &#8220;default&#8221; group created by DevStack seems to allow everything
but in fact I&#8217;ve always had problems with it, so just create your own
security group and assign your VMs to it.
Then you need to configure <tt class="docutils literal">iptables</tt> to pass through the&nbsp;traffic:</p>
<pre class="literal-block">
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</pre>
<p>(after this <a class="reference external" href="https://answers.launchpad.net/neutron/+question/208377">launchpad question</a>).</p>
</div>
<div class="section" id="note-on-unstack-sh-and-rebooting">
<h2><a class="toc-backref" href="#id3">Note on <tt class="docutils literal">unstack.sh</tt> and&nbsp;rebooting</a></h2>
<p>As I&#8217;ve found the hard way, if you ever need to reboot your DevStack <span class="caps">VM</span>,
<strong>do not</strong> run <tt class="docutils literal">unstack.sh</tt> before that.
Simply detach from screen and/or reboot as usual.
The unstacking script not only stops the services run in screen,
it also alters some configuration options of your system
that were introduced by running <tt class="docutils literal">stack.sh</tt> and setting up the DevStack.
Mostly it concerns network bridges from what I have seen.
So if you run <tt class="docutils literal">unstack.sh</tt>, in order to have a working DevStack installation
you have to run <tt class="docutils literal">stack.sh</tt> after it.
That has a drawback that all your cloud configuration
(e.g. everything stored in <span class="caps">DB</span> tables of OpenStack and content of stack-volume-backing-file) will be&nbsp;reset.</p>
<p>Thus, the work flow looks somewhat like&nbsp;this:</p>
<ol class="arabic simple">
<li>Start/configure DevStack with <tt class="docutils literal">stack.sh</tt></li>
<li>Join the stack with <tt class="docutils literal">rejoin_stack.sh</tt></li>
<li>Make changes, restarting services affected on per-service basis via screen
to put your changes in&nbsp;effect.</li>
<li>If in need to reboot the DevStack <span class="caps">VM</span>, shut it down the usual way,
and upon restart simply run <tt class="docutils literal">rejoin_stack.sh</tt> again,
all services will be started in screen&nbsp;again.</li>
<li>Only if you need to change the OpenStack/DevStack configuration,
then run <tt class="docutils literal">unstack.sh</tt>, make changes in <tt class="docutils literal">local.conf</tt> / wherever you have to
and then run <tt class="docutils literal">stack.sh</tt>.</li>
</ol>
</div>
<div class="section" id="restore-settings-after-reboot">
<h2><a class="toc-backref" href="#id4">Restore settings after&nbsp;reboot</a></h2>
<p>After reboot of the DevStack <span class="caps">VM</span> the following will be&nbsp;lost:</p>
<ul class="simple">
<li>stack volumes (this includes created storage volumes&nbsp;etc.)</li>
<li>iptables/<span class="caps">NAT</span>&nbsp;setting</li>
<li>bridges&nbsp;configurations</li>
</ul>
<p>Here how to restore these settings or make them&nbsp;permanent:</p>
<dl class="docutils">
<dt>Update</dt>
<dd>Right now it appears to be so involved to cleanly restore all the settings
lost after reboot that a much safer and easier way is to make peace with
everything in your OpenStack being lost (all the settings and things
you&#8217;ve created inside) and just run <tt class="docutils literal">stack.sh</tt> again (optionally with
<tt class="docutils literal"><span class="caps">OFFLINE</span> = True</tt> in your <tt class="docutils literal">local.conf</tt> to keep the code exactly as
before&nbsp;reboot).</dd>
</dl>
<div class="section" id="stack-volumes">
<h3><a class="toc-backref" href="#id5">Stack&nbsp;volumes</a></h3>
<p><strong>Note</strong> - with <tt class="docutils literal">Swift</tt> enabled actual loopback device may be other
than <tt class="docutils literal">/dev/loop0</tt></p>
<p>Check that volumes are created after fresh running of <tt class="docutils literal">./stack.sh</tt>:</p>
<pre class="literal-block">
sudo losetup -a
sudo pvs
sudo vgs
</pre>
<p>You should see volume group <tt class="docutils literal"><span class="pre">stack-volumes</span></tt> existing and attached to
<tt class="docutils literal"><span class="pre">/opt/stack/data/stack-volumes-backing-file</span></tt> via <tt class="docutils literal">/dev/loop0</tt>.</p>
<p>After reboot the attachment of the backing file to loopback device will
be lost. To make it permanent add the following line to your
<tt class="docutils literal">/etc/rc.local</tt> file, before <tt class="docutils literal">exit 0</tt> line:</p>
<pre class="literal-block">
losetup /dev/loop0 /opt/stack/data/stack-volumes-backing-file
</pre>
</div>
<div class="section" id="nat-settings">
<h3><a class="toc-backref" href="#id6"><span class="caps">NAT</span>&nbsp;settings</a></h3>
<p>After <a class="reference external" href="https://lists.launchpad.net/openstack/msg17016.html">this mail-list&nbsp;post</a></p>
<ul>
<li><p class="first">permanently enable <span class="caps">IP</span>-forwarding</p>
<pre class="literal-block">
sudo sed -i 's/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/' /etc/sysctl.conf
</pre>
</li>
<li><p class="first">permanently set <tt class="docutils literal">iptables</tt> settings: add to <tt class="docutils literal">/etc/interfaces</tt></p>
<pre class="literal-block">
post up iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</pre>
</li>
</ul>
</div>
<div class="section" id="bridges">
<h3><a class="toc-backref" href="#id7">Bridges</a></h3>
<p>After <a class="reference external" href="https://gist.github.com/charlesflynn/5576114">this ghist</a>.</p>
<p>Bridge <tt class="docutils literal"><span class="pre">br-ex</span></tt> has no <span class="caps">IP</span> after reboot.
Use the following commands to set bridges according to default settings
of <tt class="docutils literal">stack.sh</tt>:</p>
<blockquote>
<pre class="literal-block">
sudo ip addr flush dev br-ex
sudo ip addr add 172.24.4.1/24 dev br-ex
sudo ip link set br-ex up
sudo route add -net 10.0.0.0/24 gw 172.24.4.1
</pre>
</blockquote>
</div>
</div>
<div class="section" id="sharing-files-between-your-physical-machine-and-devstack-host">
<h2><a class="toc-backref" href="#id8">Sharing files between your physical machine and DevStack&nbsp;host</a></h2>
<p>As I use <tt class="docutils literal">vim</tt> as my Python <span class="caps">IDE</span> I personally prefer to work directly
in the console of the guest DevStack instance, but if you prefer <span class="caps">GUI</span> <span class="caps">IDE</span>
(like PyCharm) you might want to have access to the code on the DevStack
guest right from your host. One rather straightforward possibility is
<tt class="docutils literal">sshfs</tt>, but as it is usually pretty slow, you might want to try <span class="caps">NFS</span>.</p>
<p>The following is adopted from <a class="reference external" href="http://radix.twistedmatrix.com/2013/06/complete-guide-to-setting-up-openstack.html">this post by&nbsp;radix</a></p>
<p>First, install the <tt class="docutils literal"><span class="pre">nfs-kernel-server</span></tt> package on the host system and
then edit <tt class="docutils literal">/etc/exports</tt> to add the following&nbsp;line:</p>
<pre class="literal-block">
full_path_to_project_on_host    *(rw,async,root_squash,no_subtree_check)
</pre>
<p>Then in the DevStack guest install <tt class="docutils literal"><span class="pre">nfs-common</span></tt> and add the following
line to <tt class="docutils literal">/etc/fstab</tt>:</p>
<pre class="literal-block">
address_of_host:full_path_to_project_on_host    full_path_to_project_on_guest    nfs
</pre>
<p>Don&#8217;t forget to <tt class="docutils literal">mkdir full_path_to_project_on_guest</tt> in the guest.
You can then reboot the DevStack guest or just mount
<tt class="docutils literal">full_path_to_project_on_guest</tt>.</p>
</div>
<div class="section" id="problems-with-receiving-ips-for-vms">
<h2><a class="toc-backref" href="#id9">Problems with receiving IPs for&nbsp;VMs</a></h2>
<p>Some versions of VirtIO network interface seem not to fill in checksums correctly in <span class="caps">UDP</span>
packets (something called checksum offloading), which interferes with
receiving <span class="caps">DHCP</span> lease from neutron/nova-network when everything is
running on a single host (e.g. DevStack). To fix this add the following
rule to <tt class="docutils literal">iptables</tt>:</p>
<pre class="literal-block">
sudo iptables -A POSTROUTING -t mangle -p udp --dport bootpc -j CHECKSUM --checksum-fill
</pre>
</div>
<div class="section" id="nested-kvm">
<h2><a class="toc-backref" href="#id10">Nested <span class="caps">KVM</span></a></h2>
<p>If you run DevStack as a <span class="caps">KVM</span> guest, ensure that your host system has nested <span class="caps">KVM</span> enabled -
that will greatly speed up those VMs you run inside your DevStack guest
(of course your <span class="caps">CPU</span> has to support virtualization extensions and have them enabled in <span class="caps">BIOS</span>).</p>
<p>Check that nested <span class="caps">KVM</span> is&nbsp;enabled:</p>
<pre class="literal-block">
cat /sys/module/kvm_intel/parameters/nested
</pre>
<p>If it&#8217;s <tt class="docutils literal">N</tt> then try to load the module&nbsp;with</p>
<pre class="literal-block">
modprobe kvm_intel nested=1
</pre>
<p>If it worked (you get <tt class="docutils literal">Y</tt> after checking again) to make it permanent
you have to add the following line to some <tt class="docutils literal">.conf</tt> file in <tt class="docutils literal">/etc/modprobe.d/</tt>:</p>
<pre class="literal-block">
options kvm-intel nested=1
</pre>
<p>Reboot and check&nbsp;again.</p>
</div>

            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/pshchelo"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
                <li class="list-group-item"><a href="https://bitbucket.org/pshchelo"><i class="fa fa-bitbucket-square fa-lg"></i> BitBucket</a></li>
                <li class="list-group-item"><a href="https://plus.google.com/+PavloShchelokovskyy/about"><i class="fa fa-google-plus-square fa-lg"></i> Google+</a></li>
                <li class="list-group-item"><a href="https://twitter.com/pshchelo"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
                <li class="list-group-item"><a href="https://www.linkedin.com/in/pshchelo"><i class="fa fa-linkedin-square fa-lg"></i> LinkedIn</a></li>
              </ul>
            </li>





    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://python.org/" target="_blank">
                Python.org
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://www.openstack.org/" target="_blank">
                OpenStack
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2017 Pavlo Shchelokovskyy
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://pshchelo.github.io/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://pshchelo.github.io/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://pshchelo.github.io/theme/js/respond.min.js"></script>


</body>
</html>