
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://pshchelo.github.io/theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark)"
    href="https://pshchelo.github.io/theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark)"
          href="https://pshchelo.github.io/theme/pygments/solarized-light.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"
          href="https://pshchelo.github.io/theme/pygments/solarized-light.min.css">


  <link rel="stylesheet" type="text/css" href="https://pshchelo.github.io/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://pshchelo.github.io/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://pshchelo.github.io/theme/font-awesome/css/solid.css">


    <link href="https://pshchelo.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Bits and Pieces Atom">


    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">



<meta name="author" content="pas-ha" />
<meta name="description" content="auth to keystone federated via oidc with cURL calls" />
<meta name="keywords" content="openstack, keystone, federation, openid, oidc, curl">


<meta property="og:site_name" content="Bits and Pieces"/>
<meta property="og:title" content="Authentication flow with Keystone and OpenID Connect - with cURL"/>
<meta property="og:description" content="auth to keystone federated via oidc with cURL calls"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://pshchelo.github.io/drafts/keystone-oidc-curl.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2021-04-30 00:00:00+03:00"/>
<meta property="article:modified_time" content="2024-05-27 00:00:00+03:00"/>
<meta property="article:author" content="https://pshchelo.github.io/author/pas-ha.html">
<meta property="article:section" content="work"/>
<meta property="article:tag" content="openstack"/>
<meta property="article:tag" content="keystone"/>
<meta property="article:tag" content="federation"/>
<meta property="article:tag" content="openid"/>
<meta property="article:tag" content="oidc"/>
<meta property="article:tag" content="curl"/>
<meta property="og:image" content="/images/avatar.jpg">

  <title>Bits and Pieces &ndash; Authentication flow with Keystone and OpenID Connect - with cURL</title>

</head>
<body >
  <aside>
    <div>
      <a href="https://pshchelo.github.io">
        <img src="/images/avatar.jpg" alt="" title="">
      </a>

      <h1>
        <a href="https://pshchelo.github.io"></a>
      </h1>



      <nav>
        <ul class="list">


              <li>
                <a target="_self"
                   href="https://pshchelo.github.io/pages/about-me.html#about-me">
                  About Me
                </a>
              </li>

            <li>
              <a target="_self" href="http://python.org/" >Python</a>
            </li>
            <li>
              <a target="_self" href="http://www.openstack.org/" >OpenStack</a>
            </li>
        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/pshchelo" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-bitbucket" href="https://bitbucket.org/pshchelo" target="_blank">
              <i class="fab fa-bitbucket"></i>
            </a>
          </li>
          <li>
            <a  class="sc-twitter" href="https://twitter.com/pshchelo" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
          <li>
            <a  class="sc-linkedin" href="https://www.linkedin.com/in/pshchelo" target="_blank">
              <i class="fab fa-linkedin"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="https://pshchelo.github.io">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://pshchelo.github.io/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="keystone-oidc-curl">Authentication flow with Keystone and OpenID Connect - with cURL</h1>
    <p>
      Posted on Fri 30 April 2021 in <a href="https://pshchelo.github.io/category/work.html">work</a>

    </p>
  </header>


  <div>
    <p>Recently I was tasked to provide an example curl commands to realize the
authentication process required to get an OpenStack Identity (Keystone) token
for a user federated via OpenID Connect.
While usually we tend to use already established libraries like
<tt class="docutils literal">keystoneauth</tt> or <tt class="docutils literal">openstacksdk</tt> for that, but since I not so long ago
had to dive into OpenID Connect anyway, this posed  an interesting task.</p>
<p>I use
<a class="reference external" href="https://www.mirantis.com/software/mirantis-openstack-for-kubernetes/">Mirantis OpenStack for Kubernetes</a>
(naturally :-) ), that integrates
Keystone with Keycloak via OpenID Connect, OpenStack release is Victoria.</p>
<div class="section" id="pre-requisites">
<h2>Pre-requisites</h2>
<ul class="simple">
<li>OpenStack deployed and configured to use federation via OpenID Connect.</li>
<li>Account in the Identity Provider allowing you to login to OpenStack.</li>
<li><a class="reference external" href="https://docs.openstack.org/keystoneauth/latest/authentication-plugins.html#federation">v3oidcpassword</a>
authenticationauthentication enabled and working</li>
<li><tt class="docutils literal">curl</tt> and <tt class="docutils literal">jq</tt> installed and available</li>
</ul>
<div class="section" id="required-access-info">
<h3>Required access info</h3>
<p>Obtain required access info.
The commands below expect the following environment variables to be available.</p>
<dl class="docutils">
<dt>OS_AUTH_URL</dt>
<dd>the OpenStack Identity endpoint address. Note that examples below expect
a versioned endpoint (ends with <tt class="docutils literal">/v3</tt>), adapt URLs accordingly if yours
is not versioned.</dd>
<dt>OS_DISCOVERY_ENDPOINT</dt>
<dd>the URL of OpenID configuration discovery of the Identity Provider configured
in Keystone, usually ends with <tt class="docutils literal"><span class="pre">.../.well-known/openid-configuration</span></tt>.</dd>
<dt>OS_IDENTITY_PROVIDER</dt>
<dd>Name of the identity provider configured in Keystone</dd>
<dt>OS_PROTOCOL</dt>
<dd>Name of the protocol configured for this Identity Provider in Keystone</dd>
<dt>OS_CLIENT_ID</dt>
<dd>The client name to use when contacting Identity Provider
Note - this is NOT your OpenStack login</dd>
<dt>OS_CLIENT_SECRET</dt>
<dd>The password to use for the Identity Provider client.
Usually it must be kept secret,
as in standard Web SSO application of OpenID Connect,
but here, as with Kubernetes + OpenID Connect,
the CLI client is required to know it.
Some Identity Providers allow to create clients without secrets (for example
Keycloak does).</dd>
<dt>OS_OPENID_SCOPE</dt>
<dd>The scope to use for authentication, governs how much info about you the
Identity Provider will pass to the Service Provider - in this case you :-)
At least (and usually only) must be <tt class="docutils literal">openid</tt>.</dd>
<dt>OS_USERNAME</dt>
<dd>Your username with Identity Provider you want to login to OpenStack with</dd>
<dt>OS_PASSWORD</dt>
<dd>Your password for your account with the Identity Provider.</dd>
<dt>OS_PROJECT_NAME</dt>
<dd>The name of the OpenStack project you want to authenticate to.</dd>
<dt>OS_PROJECT_DOMAIN_ID</dt>
<dd>ID of the OpenStack Identity domain that project belongs to.</dd>
</dl>
<div class="section" id="get-it-from-horizon">
<h4>Get it from Horizon</h4>
<p>The easiest way to obtain those is to login via federation to Horizon,
and download the RC file from the UI</p>
<p>&lt;INSERT IMAGE HERE&gt;</p>
<p>source this file into the active shell, it will ask you for your password</p>
<div class="highlight"><pre><span></span><span class="nb">source</span><span class="w"> </span>.sh
</pre></div>
</div>
</div>
</div>
<div class="section" id="authentication-flow">
<h2>Authentication Flow</h2>
<p>Now let's start with curl-ing. I use <tt class="docutils literal"><span class="pre">-sk</span></tt> to silence the progress indicator
and, since I use development toy environment and self-signed TLS certificates,
ignore TLS verification failures.</p>
<p>I am following the calls that would've been made when using <tt class="docutils literal">keystoneauth</tt>
library with <tt class="docutils literal">v3oidcpassword</tt> authentication type.</p>
<div class="section" id="get-oidc-token-endpoint">
<h3>Get OIDC token endpoint</h3>
<p>Using the discovery endpoint, find the URL of token endpoint</p>
<div class="highlight"><pre><span></span><span class="nv">token_endpoint</span><span class="o">=</span><span class="k">$(</span>curl<span class="w"> </span>-sk<span class="w"> </span>-X<span class="w"> </span>GET<span class="w"> </span><span class="nv">$OS_DISCOVERY_ENDPOINT</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span>.token_endpoint<span class="k">)</span>
</pre></div>
</div>
<div class="section" id="get-the-oidc-access-token">
<h3>Get the OIDC access token</h3>
<div class="highlight"><pre><span></span><span class="nv">access_token</span><span class="o">=</span><span class="k">$(</span>curl<span class="w"> </span>-sk<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="nv">$token_endpoint</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-u<span class="w"> </span><span class="nv">$OS_CLIENT_ID</span>:<span class="nv">$OS_CLIENT_SECRET</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-d<span class="w"> </span><span class="s2">&quot;username=</span><span class="si">${</span><span class="nv">OS_USERNAME</span><span class="si">}</span><span class="s2">&amp;password=</span><span class="si">${</span><span class="nv">OS_PASSWORD</span><span class="si">}</span><span class="s2">&amp;scope=</span><span class="si">${</span><span class="nv">OS_OPENID_SCOPE</span><span class="si">}</span><span class="s2">&amp;grant_type=password&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/x-www-form-urlencoded&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span>.access_token<span class="k">)</span>
</pre></div>
<p>The trick is the Content-Type - as per The
<a class="reference external" href="https://openid.net/specs/openid-connect-core-1_0.html#TokenRequest">OpenID Connect RFC</a>
this is how it must be done with Form Serialization, not JSON.</p>
<p>The client id and client secret are used for HTTP Basic Authentication, again,
as per that RFC.</p>
</div>
<div class="section" id="get-the-unscoped-keystone-token">
<h3>Get the unscoped Keystone token</h3>
<p>Now the OpenStack part. In OpenStack, tokens are issued and valid in various
&quot;scopes&quot; - project, domain, system or unscoped.</p>
<p>With federation, API user is expected to first exchange the Identity Provider
token for unscoped OpenStack Identity token.</p>
<div class="highlight"><pre><span></span><span class="nv">unscoped_token</span><span class="o">=</span><span class="k">$(</span>curl<span class="w"> </span>-sik<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-I<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="nv">$OS_AUTH_URL</span>/OS-FEDERATION/identity_providers/<span class="si">${</span><span class="nv">OS_IDENTITY_PROVIDER</span><span class="si">}</span>/protocols/<span class="si">${</span><span class="nv">OS_PROTOCOL</span><span class="si">}</span>/auth<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer </span><span class="nv">$access_token</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>x-subject-token<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;\r&#39;</span><span class="k">)</span>
</pre></div>
<p>Here already we have some inconveniences with Bash:
the token arrives in the header, but the response body (json) also has some useful info
we are ignoring it but it may become useful in some applications
result of grep + awk has new line in the end, need to trim it to put into JSON</p>
</div>
<div class="section" id="prepare-json-for-scoped-token-request">
<h3>Prepare JSON for scoped token request</h3>
<div class="highlight"><pre><span></span><span class="nv">token_request</span><span class="o">=</span><span class="k">$(</span>mktemp<span class="k">)</span>
cat<span class="w"> </span>&gt;<span class="w"> </span><span class="nv">$token_request</span><span class="w"> </span><span class="s">&lt;&lt; EOJSON</span>
<span class="s">{</span>
<span class="s">  &quot;auth&quot;: {</span>
<span class="s">    &quot;identity&quot;: {</span>
<span class="s">      &quot;methods&quot;: [</span>
<span class="s">        &quot;token&quot;</span>
<span class="s">      ],</span>
<span class="s">      &quot;token&quot;: {</span>
<span class="s">        &quot;id&quot;: &quot;$unscoped_token&quot;</span>
<span class="s">      }</span>
<span class="s">    },</span>
<span class="s">    &quot;scope&quot;: {</span>
<span class="s">      &quot;project&quot;: {</span>
<span class="s">        &quot;domain&quot;: {</span>
<span class="s">          &quot;id&quot;: &quot;$OS_PROJECT_DOMAIN_ID&quot;</span>
<span class="s">        },</span>
<span class="s">        &quot;name&quot;: &quot;$OS_PROJECT_NAME&quot;</span>
<span class="s">      }</span>
<span class="s">    }</span>
<span class="s">  }</span>
<span class="s">}</span>
<span class="s">EOJSON</span>
</pre></div>
<p>Generating JSON in Bash is very awkward due to double-quotes
and lots of escaping...
just save the request JSON body to file (obviously not secure)</p>
</div>
<div class="section" id="get-scoped-token">
<h3>Get scoped token</h3>
<p>Biggest disadvantages here, as again, the token is in the headers,
but the response body contains a lot of useful info, including auth info
(UUIDs of project, domain etc, group assignments, roles if explicit,
plus the Identity Catalog that may be needed to discover the actual URL
of the service we want to acces with the received token
Again, we skip all that useful info and only fetch the token</p>
<div class="highlight"><pre><span></span><span class="nv">scoped_token</span><span class="o">=</span><span class="k">$(</span>curl<span class="w"> </span>-sik<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="nv">$OS_AUTH_URL</span>/auth/tokens<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-d<span class="w"> </span><span class="s2">&quot;@</span><span class="nv">$token_request</span><span class="s2">&quot;</span><span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>x-subject-token<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;\r&#39;</span><span class="k">)</span>
</pre></div>
<p>Remove the temporary file with token request body, tiny security improvement</p>
<div class="highlight"><pre><span></span>rm<span class="w"> </span><span class="nv">$token_request</span>
</pre></div>
</div>
</div>
<div class="section" id="use-scoped-token-to-make-request-to-an-openstack-service">
<h2>Use scoped token to make request to an OpenStack service</h2>
<p>Here hardcoded endpoint is used, however base part of it could've
been discovered from the response body of the previous request
I specifically use Glance in the example as it has no project UUID in the
endpoint, but many more services will need that.</p>
<div class="highlight"><pre><span></span>curl<span class="w"> </span>-sk<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-X<span class="w"> </span>GET<span class="w"> </span>https://glance.it.just.works/v2/images<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-H<span class="w"> </span><span class="s2">&quot;X-Auth-Token: </span><span class="nv">$scoped_token</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>.images
</pre></div>
</div>

  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://pshchelo.github.io/tag/openstack.html">openstack</a>
      <a href="https://pshchelo.github.io/tag/keystone.html">keystone</a>
      <a href="https://pshchelo.github.io/tag/federation.html">federation</a>
      <a href="https://pshchelo.github.io/tag/openid.html">openid</a>
      <a href="https://pshchelo.github.io/tag/oidc.html">oidc</a>
      <a href="https://pshchelo.github.io/tag/curl.html">curl</a>
    </p>
  </div>





<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'pshchelo';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>&copy; 2024 </p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="https://pshchelo.github.io/theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="light"
          type="text/javascript">
  </script>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Bits and Pieces ",
  "url" : "https://pshchelo.github.io",
  "image": "/images/avatar.jpg",
  "description": ""
}
</script>
<a href="https://github.com/pshchelo/pshchelo.github.io" class="github-corner" aria-label="View source on Github">
    <svg width="80"
         height="80"
         viewBox="0 0 250 250"
         style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;"
         aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor"
              style="transform-origin: 130px 106px;"
              class="octo-arm">
        </path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor"
              class="octo-body">
        </path>
    </svg>
</a>
<style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

</body>
</html>