
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://pshchelo.github.io/theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark)"
    href="https://pshchelo.github.io/theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark)"
          href="https://pshchelo.github.io/theme/pygments/solarized-light.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"
          href="https://pshchelo.github.io/theme/pygments/solarized-light.min.css">


  <link rel="stylesheet" type="text/css" href="https://pshchelo.github.io/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://pshchelo.github.io/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://pshchelo.github.io/theme/font-awesome/css/solid.css">


    <link href="https://pshchelo.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Bits and Pieces Atom">


    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">



<meta name="author" content="pshchelo" />
<meta name="description" content="Setting up local dev env to test OpenID Connect support in PyKube" />
<meta name="keywords" content="kubernetes, openid, oidc, okta, microk8s, pykube">


<meta property="og:site_name" content="Bits and Pieces"/>
<meta property="og:title" content="Testing pykube for OpenID Connect support"/>
<meta property="og:description" content="Setting up local dev env to test OpenID Connect support in PyKube"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://pshchelo.github.io/pykube-oidc-refresh.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2020-05-11 00:00:00+03:00"/>
<meta property="article:modified_time" content="2020-12-13 00:00:00+02:00"/>
<meta property="article:author" content="https://pshchelo.github.io/author/pshchelo.html">
<meta property="article:section" content="work"/>
<meta property="article:tag" content="kubernetes"/>
<meta property="article:tag" content="openid"/>
<meta property="article:tag" content="oidc"/>
<meta property="article:tag" content="okta"/>
<meta property="article:tag" content="microk8s"/>
<meta property="article:tag" content="pykube"/>
<meta property="og:image" content="/images/avatar.jpg">

  <title>Bits and Pieces &ndash; Testing pykube for OpenID Connect support</title>

</head>
<body >
  <aside>
    <div>
      <a href="https://pshchelo.github.io">
        <img src="/images/avatar.jpg" alt="" title="">
      </a>

      <h1>
        <a href="https://pshchelo.github.io"></a>
      </h1>



      <nav>
        <ul class="list">


              <li>
                <a target="_self"
                   href="https://pshchelo.github.io/pages/about-me.html#about-me">
                  About Me
                </a>
              </li>

            <li>
              <a target="_self" href="http://python.org/" >Python</a>
            </li>
            <li>
              <a target="_self" href="http://www.openstack.org/" >OpenStack</a>
            </li>
        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/pshchelo" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-bitbucket" href="https://bitbucket.org/pshchelo" target="_blank">
              <i class="fab fa-bitbucket"></i>
            </a>
          </li>
          <li>
            <a  class="sc-twitter" href="https://twitter.com/pshchelo" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
          <li>
            <a  class="sc-linkedin" href="https://www.linkedin.com/in/pshchelo" target="_blank">
              <i class="fab fa-linkedin"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="https://pshchelo.github.io">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://pshchelo.github.io/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="pykube-oidc-refresh">Testing pykube for OpenID Connect support</h1>
    <p>
      Posted on Mon 11 May 2020 in <a href="https://pshchelo.github.io/category/work.html">work</a>

    </p>
  </header>


  <div>
    <div class="section" id="why">
<h2>Why</h2>
<p>During review of my <a class="reference external" href="https://github.com/hjacobs/pykube/pull/49">PR#49</a>
to the <tt class="docutils literal">pykube</tt> library to add OpenIDConnect token
refresh capabilities I was asked to provide some instructions on how to
setup a Kubernetes cluster with OpenIDConnect for
development/testing/verification of that PR.</p>
<p>At work, we have a central common Keycloak instance running, which I was
testing my patch against.
I myself never set up something like this, so this seemed like a good
opportunity to get creative and learn something new in the process :-)</p>
<div class="section" id="update">
<h3>UPDATE</h3>
<p>The PR in question was merged and is available in <tt class="docutils literal"><span class="pre">pykybe-ng</span> &gt;= 20.10.0</tt>.</p>
<p>Also note the new home for <a class="reference external" href="https://codeberg.org/hjacobs/pykube-ng">pykube-ng</a>
at Codeberg.org.</p>
</div>
</div>
<div class="section" id="choosing-an-openid-provider">
<h2>Choosing an OpenID provider</h2>
<p>Most available sources and tools I could find are using either
Google or Azure as OpenID providers together with Kubernetes.</p>
<p>I don't have Azure account, and when I tried Google it seems that all
previous instructions were a bit outdated. Google seems to have
tightened its security around OpenID (which is understandable as &quot;Login with
Google&quot; is quite popular and may be abused). It now requires proper registered
domain for callbacks with properly signed TLS cert (not a self-signed one).
Both of those are overly restrictive / impossible for a local dev env.</p>
<p>While searching for alternatives and more info on OpenID in general I stumbled
on very nice set of articles by Okta
(<a class="reference external" href="https://developer.okta.com/blog/2017/07/25/oidc-primer-part-1">first part</a>),
that helped me a lot with understanding the concept and flow.
So I decided to give Okta a try and set up my dev env there.</p>
</div>
<div class="section" id="setting-up-okta-as-idp">
<h2>Setting up Okta as IdP</h2>
<ol class="arabic">
<li><p class="first">Create free account on <a class="reference external" href="https://developer.okta.com">https://developer.okta.com</a>
Free tier is IMO quite enough for personal development (currently it caps
at 1k monthly active users and 5 apps/clients).</p>
</li>
<li><p class="first">On the Okta site Dashboard note the &quot;Site URL&quot; (see screenshot below).
This is going to be the base of the URL of the OpenID provider and will be
used quite a lot throughout this guide.</p>
<img alt="Okta dashboard" class="align-center" src="https://pshchelo.github.io/images/pykube-oidc-refresh/okta-dashboard.png" style="width: 100%;" />
</li>
<li><p class="first">Add a new application of &quot;Web&quot; type. OpenIDConnect supports several auth
flows and AFAIU only this one supports refresh tokens that kubernetes
clients rely on.</p>
<img alt="Okta dashboard" class="align-center" src="https://pshchelo.github.io/images/pykube-oidc-refresh/okta-new-web-app.png" style="width: 100%;" />
</li>
<li><p class="first">Configure new app (I called mine <tt class="docutils literal">kube</tt>)</p>
<ul class="simple">
<li>Default <strong>Login redirect URI</strong> pointing to <em>localhost</em> is almost good
enough, you just have to <strong>make sure it uses HTTPS scheme</strong> -
Python's <tt class="docutils literal">oauth2</tt> lib is picky about that.
Change all other URIs to use <tt class="docutils literal">https</tt> as well for consistency.</li>
<li>Make sure you enable <strong>Refresh Token</strong> in <strong>Grant type allowed</strong> -
after all we are about to test them in the first place.</li>
</ul>
<img alt="Okta dashboard" class="align-center" src="https://pshchelo.github.io/images/pykube-oidc-refresh/okta-app-configure.png" style="width: 100%;" />
</li>
<li><p class="first">On the &quot;General&quot; settings of your new app there are now 3 details you going
to need further:</p>
<ul class="simple">
<li>Login redirect URI</li>
<li>Client ID</li>
<li>Client secret (required by Okta, but can be optional in e.g. Keycloak)</li>
</ul>
<img alt="Okta dashboard" class="align-center" src="https://pshchelo.github.io/images/pykube-oidc-refresh/okta-app-overview.png" style="width: 100%;" />
</li>
<li><p class="first">Go to &quot;Assignments&quot; tab of application settings and check that there is at
least you yourself assigned as user allowed to use this app
(should be by default but better to double check).
As you see on screenshot I've added couple more dummy users to my org
to play with.</p>
<img alt="Okta dashboard" class="align-center" src="https://pshchelo.github.io/images/pykube-oidc-refresh/okta-app-assignments.png" style="width: 100%;" />
</li>
</ol>
</div>
<div class="section" id="installing-and-configuring-microk8s">
<h2>Installing and configuring microk8s</h2>
<p>I am using <tt class="docutils literal">microk8s</tt> installed on my local Ubuntu machine for testing.</p>
<pre class="code bash literal-block">
sudo snap install microk8s
</pre>
<p>I use it with all plugins disabled, including RBAC one to simplify things.</p>
<p><a class="reference external" href="https://microk8s.io/docs/configuring-services">Edit</a> arguments of
<tt class="docutils literal"><span class="pre">kube-apiserver</span></tt> to add the following flags:</p>
<pre class="literal-block">
--oidc-username-claim=email
--oidc-issuer-url=&lt;okta-site-url&gt;/oauth2/default
--oidc-client-id=&lt;client-id&gt;
</pre>
<p>where <tt class="docutils literal"><span class="pre">&lt;okta-site-url&gt;</span></tt> is is your site org URL (the one looking like
<tt class="docutils literal"><span class="pre">https://dev-NNNN.okta.com</span></tt>) and <tt class="docutils literal"><span class="pre">client-id</span></tt> is the <em>Client ID</em> of the
client you've created in the previous steps.</p>
<p>Restart <tt class="docutils literal"><span class="pre">kube-apiserver</span></tt> for changes to take effect.</p>
</div>
<div class="section" id="obtaining-proper-kube-config">
<h2>Obtaining proper kube config</h2>
<p>Now is the tricky part where we need some actual code :-)</p>
<p>Effectively we need to pretend we are that web application that we've set
with Okta to get the access, id and refresh tokens.
There are already OpenIDConnect helpers for that,
but most are either public cloud specific (Google, Azure),
or otherwise hardcoded to work with other OpenID providers like Keycloak.</p>
<p>Again, to play with Python's libs implementing the OAuth2, I've written
my own small helper that theoretically should be compatible with most OpenID
providers with minimal changes.</p>
<script src="https://gist.github.com/pshchelo/952d247b4dec1bacc6e023a343e29ba8.js"></script><p>If you've been following this guide, you'd need to set some shell variables
first (here and forth I assume we are running in a virtualenv):</p>
<pre class="code bash literal-block">
pip install pykube-ng requests-oauthlib oauthlib
<span class="c1"># the same as oidc-issuer-url we've set up for kube-apiserver
</span><span class="nb">export</span> <span class="nv">OAUTH_URI</span><span class="o">=</span>&lt;your okta site url&gt;/oauth2/default
<span class="c1"># copy from Login redirect URI on General tab of our Okta applicaiton settings
</span><span class="nb">export</span> <span class="nv">OAUTH_REDIRECT_URI</span><span class="o">=</span>https://localhost:8080/authorization-code/callback
<span class="c1"># copy Client ID from General tab of your Okta application settings
</span><span class="nb">export</span> <span class="nv">OAUTH_CLIENT_ID</span><span class="o">=</span>&lt;your client id&gt;
<span class="c1"># copy Client secret from General tab of your Okta application settings
</span><span class="nb">export</span> <span class="nv">OAUTH_CLIENT_SECRET</span><span class="o">=</span>&lt;your client secret&gt;
</pre>
<p>Now run the script. It will open your default browser with the login to your
Okta site prompt. After logging in copy the <strong>whole URL</strong> your browser
was redirected to and tried to open but failed (as there should be nothing
serving requests on <tt class="docutils literal"><span class="pre">https://localhost:8080</span></tt>)
and paste it back to the script prompt at the terminal</p>
<pre class="code shell literal-block">
$ python3 k8s-oidc-helper.py
Please go to <span class="s2">&quot;&lt;REDUCTED&gt;&quot;</span> and authorize access.
Enter the full callback URL as attempted by the browser: https://localhost:8080/authorization-code/callback?code<span class="o">=</span>&lt;REDUCTED&gt;
</pre>
<p>The script will output the token it got in return, as well as a snippet
to merge into the <tt class="docutils literal">users</tt> section of your kubeconfig (and persist some of
that info in the <tt class="docutils literal">/tmp/kubeuser</tt> file).</p>
<p>Now edit your kubeconfig to add appropriate new context with the new user we've
just created and the microk8s cluster we've set up and we are ready to go:</p>
<pre class="code bash literal-block">
kubectl config use-context &lt;your new context&gt;
kubectl get ns
</pre>
</div>
<div class="section" id="testing-token-refresh-in-pukube-ng">
<h2>Testing token refresh in pukube-ng</h2>
<p>Now how to verify <tt class="docutils literal">pykube</tt> functionality:</p>
<ul>
<li><p class="first">instantiate <tt class="docutils literal">pykube</tt> from this kubeconfig and context</p>
</li>
<li><p class="first">access some kubernetes resources</p>
<ul>
<li><p class="first">for example something global like Namespaces</p>
<pre class="code shell literal-block">
$ python3 -m pykube
&gt;&gt;&gt; <span class="o">[</span>n.name <span class="k">for</span> n in Namespace.objects<span class="o">(</span>api<span class="o">)]</span>
<span class="o">[</span><span class="s1">'default'</span>, <span class="s1">'kube-node-lease'</span>, <span class="s1">'kube-public'</span>, <span class="s1">'kube-system'</span><span class="o">]</span>
</pre>
</li>
</ul>
</li>
<li><p class="first">delete user's id-token from the context</p>
<ul class="simple">
<li>alternatively you can wait for 1 hour (token expiry in Okta), but
do not access the cluster with kubectl and this context during wait time
as it will refresh the token for you</li>
</ul>
</li>
<li><p class="first">try to access k8s again</p>
</li>
</ul>
<p>W/o <a class="reference external" href="https://github.com/hjacobs/pykube/pull/49">PR#49</a> the client can't
authorize.</p>
<p>With it is successfully uses refresh-token together with the rest of the info
to get a new id token and persists it in the kubeconfig file.</p>
<p>Whenever refresh token expires itself (not sure yet of the Okta defaults
for this) you will have to repeat <a class="reference internal" href="#obtaining-proper-kube-config">Obtaining proper kube config</a> part to
actually login (with password <em>etc</em>) to get a new refresh token.</p>
</div>
<div class="section" id="links">
<h2>Links</h2>
<p>Links I've found useful and interesting while digging in all this:</p>
<ul class="simple">
<li><a class="reference external" href="https://developer.okta.com/blog/2017/07/25/oidc-primer-part-1">https://developer.okta.com/blog/2017/07/25/oidc-primer-part-1</a></li>
<li><a class="reference external" href="https://github.com/gini/dexter">https://github.com/gini/dexter</a></li>
<li><a class="reference external" href="https://github.com/micahhausler/k8s-oidc-helper">https://github.com/micahhausler/k8s-oidc-helper</a></li>
<li><a class="reference external" href="https://github.com/making/k8s-keycloak-oidc-helper">https://github.com/making/k8s-keycloak-oidc-helper</a></li>
<li><a class="reference external" href="https://blog.gini.net/frictionless-kubernetes-openid-connect-integration-f1c356140937">https://blog.gini.net/frictionless-kubernetes-openid-connect-integration-f1c356140937</a></li>
<li><a class="reference external" href="https://github.com/okta/samples-python-flask/tree/master/okta-hosted-login">https://github.com/okta/samples-python-flask/tree/master/okta-hosted-login</a></li>
<li><a class="reference external" href="https://requests-oauthlib.readthedocs.io/en/latest/oauth2_workflow.html#web-application-flow">https://requests-oauthlib.readthedocs.io/en/latest/oauth2_workflow.html#web-application-flow</a></li>
<li><a class="reference external" href="https://medium.com/&#64;mrbobbytables/kubernetes-day-2-operations-authn-authz-with-oidc-and-a-little-help-from-keycloak-de4ea1bdbbe">https://medium.com/&#64;mrbobbytables/kubernetes-day-2-operations-authn-authz-with-oidc-and-a-little-help-from-keycloak-de4ea1bdbbe</a></li>
</ul>
</div>

  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://pshchelo.github.io/tag/kubernetes.html">kubernetes</a>
      <a href="https://pshchelo.github.io/tag/openid.html">openid</a>
      <a href="https://pshchelo.github.io/tag/oidc.html">oidc</a>
      <a href="https://pshchelo.github.io/tag/okta.html">okta</a>
      <a href="https://pshchelo.github.io/tag/microk8s.html">microk8s</a>
      <a href="https://pshchelo.github.io/tag/pykube.html">pykube</a>
    </p>
  </div>





<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'pshchelo';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>&copy; 2020 </p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="https://pshchelo.github.io/theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="light"
          type="text/javascript">
  </script>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Bits and Pieces ",
  "url" : "https://pshchelo.github.io",
  "image": "/images/avatar.jpg",
  "description": ""
}
</script>
<a href="https://github.com/pshchelo/pshchelo.github.io" class="github-corner" aria-label="View source on Github">
    <svg width="80"
         height="80"
         viewBox="0 0 250 250"
         style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;"
         aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor"
              style="transform-origin: 130px 106px;"
              class="octo-arm">
        </path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor"
              class="octo-body">
        </path>
    </svg>
</a>
<style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

</body>
</html>